<script lang="ts">
	import { page } from '$app/state';
	import { PUBLIC_APP_TITLE } from '$env/static/public';
	import { setOrderState } from '$lib/client/order.svelte';
	import { Stepper } from '$lib/components/ui/stepper';
	import type { Discount } from '$lib/services';
	import { onMount } from 'svelte';
	import { getCurrentItems } from '../items-helper';
	import AccountInfo from './account-info.svelte';
	import ConfirmOrder from './confirm-order.svelte';
	import Orders from './orders.svelte';
	import PaymentDetails from './payment-details.svelte';
	import Preview from './preview.svelte';

	let { data } = $props();
	let pageIndex = $state(0);

	setOrderState();

	let discounts = $state<Discount[]>([]);
	let loaded = $state(false);
	onMount(async () => {
		await getCurrentItems(page.url.origin);
		discounts = await data.streamed.result;
		loaded = true;
	});
</script>

<svelte:head>
	<title>{PUBLIC_APP_TITLE} | Checkout</title>
	<meta
		name="description"
		content="Secure checkout â€” review items, apply discounts, enter account info, and complete payment securely via PayMongo."
	/>
</svelte:head>

<section class="flex flex-col sm:items-center">
	{#if loaded}
		{#if pageIndex === 0}
			<Orders bind:index={pageIndex} {discounts} />
		{:else}
			<Stepper
				containerClass="mx-12 sm:w-96"
				bind:active={pageIndex}
				steps={['Account Info', 'Payment Details', 'Confirm Order']}
			/>
			<div class="col-span-2 mx-6 mt-12 h-px bg-border"></div>
			<div class="mb-12 flex flex-col">
				{#if pageIndex === 1}
					<AccountInfo bind:index={pageIndex} />
				{:else if pageIndex === 2}
					<PaymentDetails bind:index={pageIndex} {discounts} />
				{:else if pageIndex === 3}
					<ConfirmOrder bind:index={pageIndex} csrfToken={data.streamed.csrfToken} />
				{/if}
				{@render Paymongo()}
			</div>
		{/if}
	{:else}
		<Preview />
	{/if}
</section>

{#snippet Paymongo()}
	<span
		aria-label="Powered by Paymongo"
		class="my-8 inline-flex place-content-center items-center gap-4 text-xs text-muted-foreground"
	>
		Powered by
		<a href="https://www.paymongo.com/" target="_blank" aria-label="Paymongo">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 359.02 61.01" class="w-24 fill-current">
				<path
					d="M19.1,36.77h9.01c1.42,0,2.66-.97,3.01-2.35l4.87-19.53c.42-1.69-.86-3.32-2.6-3.32H1.97c-1.09,0-1.88-1.02-1.62-2.07L2.52.81c.12-.48.55-.81,1.04-.81h36.71c5.51,0,9.55,5.17,8.21,10.51l-6.1,24.49c-.17.66-.76,1.12-1.45,1.12l-9.16-.08c-.96,0-1.8.64-2.04,1.58l-2.4,9.65c-.18.71-.82,1.21-1.55,1.21h-9.75c-.99,0-1.85.67-2.09,1.63l-2.41,9.68c-.18.72-.82,1.22-1.56,1.22H1.98c-1.28,0-2.23-1.2-1.93-2.45l2-8.21c.18-.72.82-1.23,1.56-1.23h8.94c1.3,0,2.43-.88,2.74-2.14l2.24-8.99c.18-.71.82-1.21,1.55-1.21ZM217.76,9.79c-.56-.52-1.18-.98-1.86-1.38-.58-.34-1.18-.62-1.83-.85-1.19-.43-2.49-.67-3.85-.67-2.09,0-4.04.55-5.68,1.52-1.44.84-2.64,1.98-3.5,3.34-.28.43-.52.88-.72,1.36-.52-1.26-1.28-2.39-2.25-3.33-.53-.52-1.13-.98-1.77-1.38-.65-.41-1.36-.74-2.11-.98-1.03-.35-2.15-.54-3.3-.54-1.99,0-3.85.56-5.41,1.52-1.98,1.22-3.5,3.09-4.24,5.31v-5.31h-6.86v30.64h6.86v-18.49c0-3.61,2.92-6.53,6.53-6.53,3.21,0,5.87,2.31,6.42,5.35v19.67h6.86v-18.39c0-3.6,2.91-6.51,6.52-6.51s6.51,2.91,6.51,6.51v18.39h6.81v-22.26c0-2.74-1.19-5.21-3.12-7.01ZM282.99,8.42c-.48-.28-1-.53-1.54-.74-1.3-.51-2.73-.78-4.22-.78-2.11,0-4.08.55-5.76,1.52-1.95,1.11-3.5,2.78-4.41,4.77v-4.77h-6.86v30.64h6.86v-17.72c0-3.97,3.22-7.19,7.2-7.19s7.19,3.22,7.19,7.19v17.72h6.86v-21.72c0-3.78-2.13-7.09-5.32-8.92ZM165.52,8.42l-8.79,21.98-8.78-21.98h-7.23l12.4,31.03-1.57,3.94c-.67,1.69-2.31,2.79-4.12,2.79h-5.4v6.77h6.16c4.09,0,7.77-2.49,9.29-6.29l15.29-38.24h-7.24ZM111.1,23.08c0,8.04-5.24,14.72-12.12,15.98-.76.14-1.55.22-2.35.22s-1.59-.08-2.35-.22c-3.39-.62-6.39-2.56-8.55-5.34v19.22h-6.86V8.42h6.86v4.02c1.31-1.68,2.94-3.06,4.77-4.02,1.86-.98,3.94-1.52,6.14-1.52s4.28.55,6.14,1.52c4.92,2.58,8.34,8.17,8.34,14.66ZM103.91,23.08c0-4.97-4.03-9-9-9s-8.99,4.03-8.99,9,4.02,9,8.99,9,9-4.03,9-9ZM256.65,23.08c0,8.04-5.87,14.72-13.56,15.98-.86.14-1.74.22-2.64.22s-1.78-.08-2.64-.22c-7.69-1.26-13.55-7.94-13.55-15.98,0-6.49,3.81-12.08,9.32-14.66,2.08-.98,4.41-1.52,6.87-1.52s4.78.55,6.87,1.52c5.51,2.58,9.33,8.17,9.33,14.66ZM249.45,23.08c0-4.97-4.03-9-9-9s-9,4.03-9,9,4.03,9,9,9,9-4.03,9-9ZM140.08,18.74v20.32h-6.86v-4.19s-.04.02-.05.03c0,0-3.84,4.16-10.01,4.16-5.64,0-10.03-2.61-10.03-8.21,0-2.07.34-6.52,5.97-9.16s13.75-1.85,14.06-1.81c-.41-3.71-3.39-6.57-7.03-6.57-3.1,0-5.73,2.08-6.7,4.99h-6.32c2.39-10.03,11.65-11.09,13.73-11.09,10.17,0,13.1,7.21,13.23,11.53ZM133.16,24.9s-.41-.06-1.08-.13c-2.31-.22-7.73-.45-10.29,1.88-.85.78-1.38,1.83-1.38,3.26,0,6.11,12.75,5.57,12.75-5.01ZM359.02,23.08c0,8.04-5.86,14.72-13.55,15.98-.86.14-1.74.22-2.64.22s-1.78-.08-2.64-.22c-7.69-1.26-13.56-7.94-13.56-15.98,0-6.49,3.81-12.08,9.33-14.66,2.08-.98,4.41-1.52,6.87-1.52s4.78.55,6.87,1.52c5.51,2.58,9.32,8.17,9.32,14.66ZM351.82,23.08c0-4.97-4.02-9-8.99-9s-9,4.03-9,9,4.03,9,9,9,8.99-4.03,8.99-9ZM322.93,8.42v28.34c0,.78-.05,1.55-.16,2.31-.08.55-.18,1.08-.32,1.61-.5,2.01-1.38,3.87-2.55,5.51-1.05,1.48-2.35,2.76-3.83,3.81-2.64,1.87-5.86,2.97-9.33,2.97-5.42,0-10.23-2.68-13.16-6.77-1.18-1.64-2.05-3.5-2.55-5.51h7.66c1.04,2.71,3.35,4.8,6.21,5.51.69.18,1.42.27,2.18.27s1.48-.09,2.18-.27c2.86-.71,5.18-2.79,6.22-5.51.2-.52.35-1.05.45-1.61.1-.52.15-1.06.15-1.61v-3.01c-.12.15-.25.28-.38.42-2.05,2.17-4.68,3.68-7.58,4.21-.76.14-1.55.22-2.35.22s-1.59-.08-2.35-.22c-1.91-.35-3.71-1.12-5.29-2.23-2.55-1.78-4.57-4.41-5.73-7.55-.71-1.91-1.1-4-1.1-6.2,0-6.49,3.41-12.08,8.34-14.66,1.86-.98,3.94-1.52,6.14-1.52s4.28.55,6.14,1.52c1.57.82,2.98,1.95,4.18,3.31v-3.31h6.86ZM316.47,23.08c0-.92-.14-1.79-.39-2.62-1.11-3.69-4.54-6.37-8.6-6.37-4.88,0-8.86,3.89-8.99,8.74,0,.08,0,.17,0,.25,0,2.85,1.32,5.38,3.39,7.04,1.54,1.23,3.48,1.96,5.61,1.96,1.94,0,3.74-.62,5.21-1.67,1.6-1.13,2.81-2.78,3.39-4.71.19-.62.32-1.25.36-1.91.02-.23.03-.47.03-.71ZM133.16,19.88h0"
				/>
			</svg>
		</a>
	</span>
{/snippet}
